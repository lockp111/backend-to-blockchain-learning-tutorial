# Day 6: Bitcoin æ”¯ä»˜ç³»ç»Ÿå¼€å‘

> **å­¦ä¹ æ—¶é—´**ï¼š4-6 å°æ—¶ï¼ˆç†è®º 1.5h + å®æˆ˜ 3-4h + å¤ä¹  0.5hï¼‰
> 
> **æ ¸å¿ƒç›®æ ‡**ï¼šæŒæ¡ Bitcoin æ”¯ä»˜ç³»ç»Ÿå¼€å‘ï¼Œå®ç°äº¤æ˜“ç›‘å¬ä¸ Reorg å¤„ç†

---

## ğŸ¯ ä»Šæ—¥å­¦ä¹ ç›®æ ‡

- [ ] ç†è§£ Bitcoin èŠ‚ç‚¹ APIï¼ˆBitcoin Core RPC, Btcdï¼‰
- [ ] æŒæ¡ SPV é’±åŒ…çš„è½»å®¢æˆ·ç«¯åŸç†
- [ ] ç†è§£äº¤æ˜“å¹¿æ’­ä¸ç¡®è®¤æœºåˆ¶ï¼ˆMempool, RBFï¼‰
- [ ] è®¾è®¡æ”¯ä»˜åœºæ™¯ï¼šæ”¶æ¬¾ç›‘å¬ä¸å½’é›†ç­–ç•¥
- [ ] å®ç° Watcher æ¶æ„ï¼šRPC è½®è¯¢ vs ZMQ è®¢é˜…
- [ ] å¤„ç†åŒºå—é‡ç»„ï¼ˆReorgï¼‰ä¸å¹‚ç­‰å……å€¼é€»è¾‘

---

## ğŸ“š ç†è®ºè¯¾

### 1. Bitcoin èŠ‚ç‚¹ä¸ API

#### 1.1 èŠ‚ç‚¹ç±»å‹å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bitcoin èŠ‚ç‚¹ç±»å‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Full Node     â”‚  â”‚   Pruned Node   â”‚  â”‚  SPV Client â”‚ â”‚
â”‚  â”‚   (å®Œæ•´èŠ‚ç‚¹)    â”‚  â”‚   (ä¿®å‰ªèŠ‚ç‚¹)    â”‚  â”‚  (è½»å®¢æˆ·ç«¯) â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ å­˜å‚¨å…¨éƒ¨åŒºå—    â”‚  â”‚ åªä¿ç•™æœ€è¿‘åŒºå—  â”‚  â”‚ åªå­˜åŒºå—å¤´  â”‚ â”‚
â”‚  â”‚ ~500GB+         â”‚  â”‚ ~10GB           â”‚  â”‚ ~50MB       â”‚ â”‚
â”‚  â”‚ å®Œå…¨éªŒè¯        â”‚  â”‚ å®Œå…¨éªŒè¯        â”‚  â”‚ ç®€åŒ–éªŒè¯    â”‚ â”‚
â”‚  â”‚ å¯æŸ¥è¯¢å†å²      â”‚  â”‚ æ— æ³•æŸ¥è¯¢æ—§æ•°æ®  â”‚  â”‚ ä¾èµ–èŠ‚ç‚¹    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  æ¨èï¼šæ”¯ä»˜ç³»ç»Ÿä½¿ç”¨ Full Node æˆ– Pruned Node               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 ä¸»æµèŠ‚ç‚¹å®ç°

| èŠ‚ç‚¹å®ç°                    | è¯­è¨€   | ç‰¹ç‚¹                 | é€‚ç”¨åœºæ™¯     |
| :-------------------------- | :----- | :------------------- | :----------- |
| **Bitcoin Core (bitcoind)** | C++    | å®˜æ–¹å®ç°ï¼Œæœ€ç¨³å®š     | ç”Ÿäº§ç¯å¢ƒé¦–é€‰ |
| **btcd**                    | Go     | çº¯ Go å®ç°ï¼Œæ˜“äºé›†æˆ | Go åç«¯å¼€å‘  |
| **libbitcoin**              | C++    | æ¨¡å—åŒ–è®¾è®¡           | é«˜æ€§èƒ½ç´¢å¼•   |
| **Electrum Server**         | Python | ä¸ºé’±åŒ…ä¼˜åŒ–çš„ç´¢å¼•æœåŠ¡ | é’±åŒ…åç«¯     |

#### 1.3 Bitcoin Core RPC æ¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¸¸ç”¨ RPC æ–¹æ³•åˆ†ç±»                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€åŒºå—é“¾æŸ¥è¯¢ã€‘                                              â”‚
â”‚  â€¢ getblockchaininfo    - è·å–é“¾çŠ¶æ€                        â”‚
â”‚  â€¢ getblock             - è·å–åŒºå—è¯¦æƒ…                      â”‚
â”‚  â€¢ getblockhash         - æ ¹æ®é«˜åº¦è·å–å“ˆå¸Œ                  â”‚
â”‚  â€¢ getbestblockhash     - è·å–æœ€æ–°åŒºå—å“ˆå¸Œ                  â”‚
â”‚                                                             â”‚
â”‚  ã€äº¤æ˜“ç›¸å…³ã€‘                                                â”‚
â”‚  â€¢ getrawtransaction    - è·å–åŸå§‹äº¤æ˜“                      â”‚
â”‚  â€¢ decoderawtransaction - è§£ç äº¤æ˜“                          â”‚
â”‚  â€¢ sendrawtransaction   - å¹¿æ’­äº¤æ˜“                          â”‚
â”‚  â€¢ gettxout             - è·å– UTXO                         â”‚
â”‚                                                             â”‚
â”‚  ã€é’±åŒ…ç›¸å…³ã€‘                                                â”‚
â”‚  â€¢ listunspent          - åˆ—å‡ºæœªèŠ±è´¹è¾“å‡º                    â”‚
â”‚  â€¢ importaddress        - å¯¼å…¥ç›‘æ§åœ°å€                      â”‚
â”‚  â€¢ listtransactions     - åˆ—å‡ºäº¤æ˜“å†å²                      â”‚
â”‚                                                             â”‚
â”‚  ã€å†…å­˜æ± ã€‘                                                  â”‚
â”‚  â€¢ getmempoolinfo       - å†…å­˜æ± çŠ¶æ€                        â”‚
â”‚  â€¢ getrawmempool        - è·å–å†…å­˜æ± äº¤æ˜“                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. SPV é’±åŒ…åŸç†

#### 2.1 SPV (Simplified Payment Verification)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SPV éªŒè¯åŸç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  SPV å®¢æˆ·ç«¯ä¸ä¸‹è½½å®Œæ•´åŒºå—ï¼Œåªä¸‹è½½åŒºå—å¤´ (80 bytes/block)    â”‚
â”‚                                                             â”‚
â”‚  éªŒè¯æµç¨‹ï¼š                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. ä¸‹è½½æ‰€æœ‰åŒºå—å¤´                                      â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  2. éªŒè¯åŒºå—å¤´é“¾çš„æœ‰æ•ˆæ€§ï¼ˆPoW + è¿ç»­æ€§ï¼‰               â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  3. è¯·æ±‚ç‰¹å®šäº¤æ˜“çš„ Merkle Proof                        â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  4. éªŒè¯äº¤æ˜“åŒ…å«åœ¨æŸä¸ªåŒºå—ä¸­                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  Merkle Proof éªŒè¯ï¼š                                        â”‚
â”‚                                                             â”‚
â”‚            [Merkle Root]  â† åŒºå—å¤´ä¸­                        â”‚
â”‚               /    \                                        â”‚
â”‚           [H12]    [H34]  â† Proof æä¾›                      â”‚
â”‚           /  \     /  \                                     â”‚
â”‚        [H1] [H2] [H3] [H4]                                  â”‚
â”‚         â†‘                                                   â”‚
â”‚       æˆ‘çš„äº¤æ˜“                                               â”‚
â”‚                                                             â”‚
â”‚  åªéœ€ O(log N) ä¸ªå“ˆå¸Œå³å¯éªŒè¯äº¤æ˜“å­˜åœ¨                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bloom Filter å·¥ä½œåŸç†                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é—®é¢˜ï¼šSPV å®¢æˆ·ç«¯å¦‚ä½•åœ¨ä¸æš´éœ²éšç§çš„æƒ…å†µä¸‹è¯·æ±‚ç›¸å…³äº¤æ˜“ï¼Ÿ     â”‚
â”‚                                                             â”‚
â”‚  è§£å†³æ–¹æ¡ˆï¼šBloom Filter (BIP-37)                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SPV å®¢æˆ·ç«¯                    Full Node             â”‚  â”‚
â”‚  â”‚      â”‚                             â”‚                 â”‚  â”‚
â”‚  â”‚      â”‚ â”€â”€â”€â”€ å‘é€ Bloom Filter â”€â”€â”€â”€â†’â”‚                 â”‚  â”‚
â”‚  â”‚      â”‚      (åŒ…å«æˆ‘çš„åœ°å€ç‰¹å¾)      â”‚                 â”‚  â”‚
â”‚  â”‚      â”‚                             â”‚                 â”‚  â”‚
â”‚  â”‚      â”‚ â†â”€â”€â”€ è¿”å›åŒ¹é…çš„äº¤æ˜“ â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚  â”‚
â”‚  â”‚      â”‚      (å¯èƒ½æœ‰è¯¯æŠ¥)            â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  éšç§æƒè¡¡ï¼š                                                  â”‚
â”‚  â€¢ è¿‡æ»¤å™¨è¶Šç²¾ç¡® â†’ éšç§è¶Šå·®                                  â”‚
â”‚  â€¢ è¿‡æ»¤å™¨è¶Šæ¨¡ç³Š â†’ å¸¦å®½æµªè´¹è¶Šå¤š                              â”‚
â”‚                                                             â”‚
â”‚  æ³¨æ„ï¼šBIP-37 æœ‰éšç§æ³„éœ²é£é™©ï¼Œå»ºè®®ä½¿ç”¨ Compact Block        â”‚
â”‚        Filter (BIP-157/158) æ›¿ä»£                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. äº¤æ˜“å¹¿æ’­ä¸ç¡®è®¤

#### 3.1 äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº¤æ˜“ç”Ÿå‘½å‘¨æœŸ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ„é€ äº¤æ˜“ â”‚â”€â”€â”€â†’â”‚ ç­¾å    â”‚â”€â”€â”€â†’â”‚ å¹¿æ’­    â”‚â”€â”€â”€â†’â”‚ å…¥æ±     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                  â”‚          â”‚
â”‚                                                  â†“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ·±åº¦ç¡®è®¤ â”‚â†â”€â”€â”€â”‚ 1-conf  â”‚â†â”€â”€â”€â”‚ æ‰“åŒ…    â”‚â†â”€â”€â”€â”‚ Mempool â”‚ â”‚
â”‚  â”‚ (6-conf) â”‚    â”‚         â”‚    â”‚ å‡ºå—    â”‚    â”‚         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ç¡®è®¤é˜ˆå€¼å»ºè®®ï¼š                                              â”‚
â”‚  â€¢ 0-conf: ä»…é€‚ç”¨äºå°é¢ã€å¯ä¿¡åœºæ™¯                           â”‚
â”‚  â€¢ 1-conf: ä½é£é™©äº¤æ˜“                                       â”‚
â”‚  â€¢ 3-conf: ä¸€èˆ¬äº¤æ˜“                                         â”‚
â”‚  â€¢ 6-conf: å¤§é¢äº¤æ˜“ï¼ˆçº¦ 1 å°æ—¶ï¼‰                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 Mempoolï¼ˆå†…å­˜æ± ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Mempool æœºåˆ¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Mempool = ç­‰å¾…è¢«æ‰“åŒ…çš„äº¤æ˜“æ±                                â”‚
â”‚                                                             â”‚
â”‚  ç‰¹æ€§ï¼š                                                      â”‚
â”‚  â€¢ æ¯ä¸ªèŠ‚ç‚¹çš„ Mempool å¯èƒ½ä¸åŒ                              â”‚
â”‚  â€¢ é»˜è®¤æœ€å¤§ 300MB                                           â”‚
â”‚  â€¢ ä½æ‰‹ç»­è´¹äº¤æ˜“å¯èƒ½è¢«é©±é€                                   â”‚
â”‚  â€¢ äº¤æ˜“å¯èƒ½æ°¸è¿œä¸è¢«ç¡®è®¤                                     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Mempool äº¤æ˜“ä¼˜å…ˆçº§                       â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚    é«˜æ‰‹ç»­è´¹ç‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¼˜å…ˆæ‰“åŒ…     â”‚  â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50 sat/vB                        â”‚    â”‚  â”‚
â”‚  â”‚    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   30 sat/vB                        â”‚    â”‚  â”‚
â”‚  â”‚    â”‚ â–ˆâ–ˆâ–ˆâ–ˆ     20 sat/vB                        â”‚    â”‚  â”‚
â”‚  â”‚    â”‚ â–ˆâ–ˆ       10 sat/vB                        â”‚    â”‚  â”‚
â”‚  â”‚    â”‚ â–ˆ         5 sat/vB  â† å¯èƒ½è¢«é©±é€          â”‚    â”‚  â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3 RBF (Replace-By-Fee)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RBF æ›¿æ¢æœºåˆ¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  RBF å…è®¸ç”¨æ›´é«˜æ‰‹ç»­è´¹çš„äº¤æ˜“æ›¿æ¢ Mempool ä¸­çš„äº¤æ˜“            â”‚
â”‚                                                             â”‚
â”‚  å¯ç”¨æ¡ä»¶ï¼š                                                  â”‚
â”‚  â€¢ nSequence < 0xFFFFFFFE (BIP-125)                         â”‚
â”‚  â€¢ æ–°äº¤æ˜“æ‰‹ç»­è´¹å¿…é¡»æ›´é«˜                                     â”‚
â”‚                                                             â”‚
â”‚  åœºæ™¯ï¼š                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  TX_v1: Alice â†’ Bob, 10 sat/vB                         â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  ç­‰å¾…å¤ªä¹…ï¼Œæƒ³åŠ é€Ÿ                                        â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  TX_v2: Alice â†’ Bob, 50 sat/vB (æ›¿æ¢ TX_v1)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  å®‰å…¨è€ƒè™‘ï¼š                                                  â”‚
â”‚  âš ï¸ 0-conf äº¤æ˜“å¦‚æœå¯ç”¨äº† RBFï¼Œå¯èƒ½è¢«æ›¿æ¢ï¼ˆåŒèŠ±æ”»å‡»ï¼‰       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. Watcher æ¶æ„è®¾è®¡

#### 4.1 ç›‘å¬æ¶æ„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘å¬æ¶æ„å¯¹æ¯”                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€æ–¹æ¡ˆ 1: RPC è½®è¯¢ã€‘                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Watcher â”€â”€(æ¯éš” N ç§’)â”€â”€â†’ getblock / listunspent       â”‚ â”‚
â”‚  â”‚     â”‚                                                   â”‚ â”‚
â”‚  â”‚     â”œâ”€â”€ ä¼˜ç‚¹: å®ç°ç®€å•ï¼Œå…¼å®¹æ€§å¥½                        â”‚ â”‚
â”‚  â”‚     â””â”€â”€ ç¼ºç‚¹: å»¶è¿Ÿé«˜ï¼Œèµ„æºæµªè´¹                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ã€æ–¹æ¡ˆ 2: ZMQ è®¢é˜…ã€‘(æ¨è)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  bitcoind â”€â”€(æ¨é€)â”€â”€â†’ ZMQ â”€â”€â†’ Watcher                  â”‚ â”‚
â”‚  â”‚     â”‚                                                   â”‚ â”‚
â”‚  â”‚     â”œâ”€â”€ rawtx: æ–°äº¤æ˜“é€šçŸ¥                               â”‚ â”‚
â”‚  â”‚     â”œâ”€â”€ rawblock: æ–°åŒºå—é€šçŸ¥                            â”‚ â”‚
â”‚  â”‚     â”œâ”€â”€ hashtx: äº¤æ˜“å“ˆå¸Œé€šçŸ¥                            â”‚ â”‚
â”‚  â”‚     â””â”€â”€ hashblock: åŒºå—å“ˆå¸Œé€šçŸ¥                         â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚     â”œâ”€â”€ ä¼˜ç‚¹: å®æ—¶æ€§å¥½ï¼Œèµ„æºæ•ˆç‡é«˜                      â”‚ â”‚
â”‚  â”‚     â””â”€â”€ ç¼ºç‚¹: éœ€è¦é…ç½® ZMQ                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ã€æ–¹æ¡ˆ 3: æ··åˆæ¨¡å¼ã€‘(ç”Ÿäº§æ¨è)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ZMQ (ä¸»é€šé“) + RPC è½®è¯¢ (è¡¥æ¼/æ¢å¤)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2 ZMQ é…ç½®

```ini
# bitcoin.conf
zmqpubhashtx=tcp://127.0.0.1:28332
zmqpubhashblock=tcp://127.0.0.1:28332
zmqpubrawtx=tcp://127.0.0.1:28333
zmqpubrawblock=tcp://127.0.0.1:28333
```

---

### 5. Reorgï¼ˆåŒºå—é‡ç»„ï¼‰å¤„ç†

#### 5.1 ä»€ä¹ˆæ˜¯ Reorgï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒºå—é‡ç»„ (Reorg)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å½“ä¸¤ä¸ªçŸ¿å·¥å‡ ä¹åŒæ—¶æŒ–å‡ºåŒºå—æ—¶ï¼Œç½‘ç»œä¼šå‡ºç°åˆ†å‰ï¼š             â”‚
â”‚                                                             â”‚
â”‚            â”Œâ”€â”€ Block A â”€â”€ Block A' â”€â”€ Block A'' â”€â”€â†’        â”‚
â”‚  Genesis â”€â”€â”¤                                                â”‚
â”‚            â””â”€â”€ Block B â”€â”€ Block B'  (è¢«æŠ›å¼ƒ)                â”‚
â”‚                                                             â”‚
â”‚  è¾ƒé•¿çš„é“¾ä¼šè·èƒœï¼Œè¾ƒçŸ­çš„é“¾ä¸Šçš„äº¤æ˜“ä¼šï¼š                       â”‚
â”‚  â€¢ å›åˆ° Mempool ç­‰å¾…é‡æ–°æ‰“åŒ…                                â”‚
â”‚  â€¢ æˆ–è€…æ°¸ä¹…å¤±æ•ˆï¼ˆå¦‚æœä¸èƒœå‡ºé“¾å†²çªï¼‰                         â”‚
â”‚                                                             â”‚
â”‚  âš ï¸ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ç­‰å¾…å¤šä¸ªç¡®è®¤ï¼                          â”‚
â”‚                                                             â”‚
â”‚  Reorg æ·±åº¦ç»Ÿè®¡ï¼š                                            â”‚
â”‚  â€¢ 1 åŒºå— Reorg: å¶å°”å‘ç”Ÿ                                   â”‚
â”‚  â€¢ 2 åŒºå— Reorg: å¾ˆå°‘å‘ç”Ÿ                                   â”‚
â”‚  â€¢ 6 åŒºå— Reorg: æå…¶ç½•è§ï¼ˆå¯èƒ½æ˜¯æ”»å‡»ï¼‰                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.2 Reorg å¤„ç†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Reorg å¤„ç†ç­–ç•¥                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€æ•°æ®åº“è®¾è®¡ã€‘                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  deposits è¡¨:                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ id | txid | block_hash | block_height | confs   â”‚   â”‚ â”‚
â”‚  â”‚  â”‚    | amount | address | status | created_at     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  status: pending â†’ confirmed â†’ credited                 â”‚ â”‚
â”‚  â”‚                  â†˜ orphaned (Reorg æ—¶)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ã€å¤„ç†æµç¨‹ã€‘                                                â”‚
â”‚  1. æ–°åŒºå—åˆ°è¾¾ â†’ æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥åŒºå—çš„å­å—                   â”‚
â”‚  2. å¦‚æœ prevHash ä¸åŒ¹é… â†’ æ£€æµ‹åˆ° Reorg                     â”‚
â”‚  3. å›æ»šåˆ°åˆ†å‰ç‚¹                                            â”‚
â”‚  4. å°†å—å½±å“çš„äº¤æ˜“æ ‡è®°ä¸º orphaned                           â”‚
â”‚  5. é‡æ–°å¤„ç†æ–°é“¾ä¸Šçš„äº¤æ˜“                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. æ”¯ä»˜åœºæ™¯è®¾è®¡

#### 6.1 æ”¶æ¬¾ç›‘å¬æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ”¶æ¬¾ç›‘å¬æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Address    â”‚â”€â”€â”€â†’â”‚ Watcher    â”‚â”€â”€â”€â†’â”‚ Business Logic     â”‚â”‚
â”‚  â”‚ Generator  â”‚    â”‚ Service    â”‚    â”‚ (å……å€¼å¤„ç†)         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚        â”‚                 â”‚                    â”‚             â”‚
â”‚        â†“                 â†“                    â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ HD Wallet  â”‚    â”‚ Bitcoin    â”‚    â”‚ Database           â”‚â”‚
â”‚  â”‚ (æ´¾ç”Ÿåœ°å€) â”‚    â”‚ Node       â”‚    â”‚ (äº¤æ˜“è®°å½•)         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  æµç¨‹:                                                       â”‚
â”‚  1. ä¸ºç”¨æˆ·ç”Ÿæˆç‹¬ç«‹æ”¶æ¬¾åœ°å€ (HD æ´¾ç”Ÿ)                        â”‚
â”‚  2. Watcher ç›‘æ§åœ°å€ UTXO å˜åŒ–                              â”‚
â”‚  3. æ£€æµ‹åˆ°å…¥è´¦ â†’ è®°å½• 0-conf çŠ¶æ€                           â”‚
â”‚  4. ç­‰å¾…ç¡®è®¤ â†’ æ›´æ–°ç¡®è®¤æ•°                                   â”‚
â”‚  5. è¾¾åˆ°é˜ˆå€¼ â†’ è§¦å‘ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚å……å€¼åˆ°è´¦ï¼‰                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6.2 å½’é›†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UTXO å½’é›†ç­–ç•¥                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¸ºä»€ä¹ˆéœ€è¦å½’é›†ï¼Ÿ                                            â”‚
â”‚  â€¢ æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªåœ°å€ â†’ UTXO åˆ†æ•£                             â”‚
â”‚  â€¢ å¤§é‡å°é¢ UTXO â†’ æ‰‹ç»­è´¹æµªè´¹                               â”‚
â”‚  â€¢ å®‰å…¨è€ƒè™‘ â†’ é›†ä¸­åˆ°å†·é’±åŒ…                                  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç”¨æˆ·åœ°å€ A â”€â”€â”                                         â”‚ â”‚
â”‚  â”‚  ç”¨æˆ·åœ°å€ B â”€â”€â”¼â”€â”€â†’ å½’é›†äº¤æ˜“ â”€â”€â†’ çƒ­é’±åŒ… â”€â”€â†’ å†·é’±åŒ…      â”‚ â”‚
â”‚  â”‚  ç”¨æˆ·åœ°å€ C â”€â”€â”˜                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  å½’é›†è§¦å‘æ¡ä»¶:                                               â”‚
â”‚  â€¢ é‡‘é¢é˜ˆå€¼: å•åœ°å€ä½™é¢ > X BTC                             â”‚
â”‚  â€¢ æ—¶é—´é˜ˆå€¼: è·ä¸Šæ¬¡å½’é›† > N å¤©                              â”‚
â”‚  â€¢ æ‰‹åŠ¨è§¦å‘: å®‰å…¨éœ€è¦æ—¶                                     â”‚
â”‚                                                             â”‚
â”‚  æ‰‹ç»­è´¹ä¼˜åŒ–:                                                 â”‚
â”‚  â€¢ ä½è´¹ç‡æ—¶æ®µå½’é›†                                           â”‚
â”‚  â€¢ æ‰¹é‡åˆå¹¶å¤šä¸ª UTXO                                        â”‚
â”‚  â€¢ è€ƒè™‘ UTXO æ•´åˆæˆæœ¬ vs åç»­ä½¿ç”¨æˆæœ¬                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å®æˆ˜ä½œä¸š

### ä½œä¸š 1: ç¯å¢ƒå‡†å¤‡

```bash
mkdir -p ~/blockchain-course/day06
cd ~/blockchain-course/day06
go mod init day06

# å®‰è£…ä¾èµ–
go get github.com/btcsuite/btcd/rpcclient
go get github.com/btcsuite/btcd/chaincfg
go get github.com/btcsuite/btcd/btcjson
go get github.com/btcsuite/btcd/wire
go get github.com/pebbe/zmq4  # ZMQ å®¢æˆ·ç«¯
```

---

### ä½œä¸š 2: Bitcoin RPC å®¢æˆ·ç«¯

åˆ›å»º `rpc_client.go`:

```go
package main

import (
	"fmt"
	"log"

	"github.com/btcsuite/btcd/btcjson"
	"github.com/btcsuite/btcd/chaincfg/chainhash"
	"github.com/btcsuite/btcd/rpcclient"
)

// BitcoinClient å°è£… Bitcoin RPC å®¢æˆ·ç«¯
type BitcoinClient struct {
	client *rpcclient.Client
}

// NewBitcoinClient åˆ›å»ºæ–°çš„ Bitcoin å®¢æˆ·ç«¯
func NewBitcoinClient(host, user, pass string) (*BitcoinClient, error) {
	connCfg := &rpcclient.ConnConfig{
		Host:         host,
		User:         user,
		Pass:         pass,
		HTTPPostMode: true,
		DisableTLS:   true,
	}

	client, err := rpcclient.New(connCfg, nil)
	if err != nil {
		return nil, fmt.Errorf("åˆ›å»º RPC å®¢æˆ·ç«¯å¤±è´¥: %w", err)
	}

	return &BitcoinClient{client: client}, nil
}

// GetBlockchainInfo è·å–åŒºå—é“¾ä¿¡æ¯
func (bc *BitcoinClient) GetBlockchainInfo() (*btcjson.GetBlockChainInfoResult, error) {
	return bc.client.GetBlockChainInfo()
}

// GetBlockCount è·å–å½“å‰åŒºå—é«˜åº¦
func (bc *BitcoinClient) GetBlockCount() (int64, error) {
	return bc.client.GetBlockCount()
}

// GetBlockHash æ ¹æ®é«˜åº¦è·å–åŒºå—å“ˆå¸Œ
func (bc *BitcoinClient) GetBlockHash(height int64) (*chainhash.Hash, error) {
	return bc.client.GetBlockHash(height)
}

// GetBlock è·å–åŒºå—è¯¦æƒ…
func (bc *BitcoinClient) GetBlock(hash *chainhash.Hash) (*btcjson.GetBlockVerboseResult, error) {
	return bc.client.GetBlockVerbose(hash)
}

// GetRawMempool è·å–å†…å­˜æ± äº¤æ˜“
func (bc *BitcoinClient) GetRawMempool() ([]*chainhash.Hash, error) {
	return bc.client.GetRawMempool()
}

// Close å…³é—­è¿æ¥
func (bc *BitcoinClient) Close() {
	bc.client.Shutdown()
}

func main() {
	// è¿æ¥åˆ° Bitcoin èŠ‚ç‚¹ (ä½¿ç”¨ä½ çš„é…ç½®)
	client, err := NewBitcoinClient(
		"localhost:8332",
		"rpcuser",
		"rpcpassword",
	)
	if err != nil {
		log.Fatalf("è¿æ¥å¤±è´¥: %v", err)
	}
	defer client.Close()

	// è·å–åŒºå—é“¾ä¿¡æ¯
	info, err := client.GetBlockchainInfo()
	if err != nil {
		log.Printf("è·å–åŒºå—é“¾ä¿¡æ¯å¤±è´¥: %v", err)
	} else {
		fmt.Println("=== åŒºå—é“¾ä¿¡æ¯ ===")
		fmt.Printf("é“¾: %s\n", info.Chain)
		fmt.Printf("åŒºå—æ•°: %d\n", info.Blocks)
		fmt.Printf("æœ€ä½³åŒºå—å“ˆå¸Œ: %s\n", info.BestBlockHash)
		fmt.Printf("éªŒè¯è¿›åº¦: %.2f%%\n", info.VerificationProgress*100)
	}

	// è·å–æœ€æ–°åŒºå—
	height, err := client.GetBlockCount()
	if err != nil {
		log.Printf("è·å–åŒºå—é«˜åº¦å¤±è´¥: %v", err)
	} else {
		fmt.Printf("\nå½“å‰åŒºå—é«˜åº¦: %d\n", height)

		hash, _ := client.GetBlockHash(height)
		block, _ := client.GetBlock(hash)
		if block != nil {
			fmt.Printf("æœ€æ–°åŒºå—äº¤æ˜“æ•°: %d\n", len(block.Tx))
		}
	}

	// è·å–å†…å­˜æ± çŠ¶æ€
	mempool, err := client.GetRawMempool()
	if err != nil {
		log.Printf("è·å–å†…å­˜æ± å¤±è´¥: %v", err)
	} else {
		fmt.Printf("\nå†…å­˜æ± äº¤æ˜“æ•°: %d\n", len(mempool))
	}
}
```

---

### ä½œä¸š 3: Deposit Watcher å®ç°

åˆ›å»º `deposit_watcher.go`:

```go
package main

import (
	"context"
	"fmt"
	"log"
	"sync"
	"time"

	"github.com/btcsuite/btcd/chaincfg/chainhash"
	"github.com/btcsuite/btcd/rpcclient"
)

// DepositStatus å……å€¼çŠ¶æ€
type DepositStatus string

const (
	StatusPending   DepositStatus = "pending"   // 0-conf
	StatusConfirmed DepositStatus = "confirmed" // è¾¾åˆ°ç¡®è®¤é˜ˆå€¼
	StatusCredited  DepositStatus = "credited"  // å·²å…¥è´¦
	StatusOrphaned  DepositStatus = "orphaned"  // Reorg è¢«å­¤ç«‹
)

// Deposit å……å€¼è®°å½•
type Deposit struct {
	TxID          string
	Address       string
	Amount        int64 // satoshis
	BlockHash     string
	BlockHeight   int64
	Confirmations int64
	Status        DepositStatus
	CreatedAt     time.Time
	UpdatedAt     time.Time
}

// DepositWatcher å……å€¼ç›‘æ§å™¨
type DepositWatcher struct {
	client            *rpcclient.Client
	watchAddresses    map[string]bool
	deposits          map[string]*Deposit
	mu                sync.RWMutex
	confirmThreshold  int64
	lastProcessedHash string
	pollInterval      time.Duration
}

// NewDepositWatcher åˆ›å»ºå……å€¼ç›‘æ§å™¨
func NewDepositWatcher(client *rpcclient.Client, threshold int64) *DepositWatcher {
	return &DepositWatcher{
		client:           client,
		watchAddresses:   make(map[string]bool),
		deposits:         make(map[string]*Deposit),
		confirmThreshold: threshold,
		pollInterval:     10 * time.Second,
	}
}

// AddWatchAddress æ·»åŠ ç›‘æ§åœ°å€
func (w *DepositWatcher) AddWatchAddress(addr string) {
	w.mu.Lock()
	defer w.mu.Unlock()
	w.watchAddresses[addr] = true
	log.Printf("æ·»åŠ ç›‘æ§åœ°å€: %s", addr)
}

// Start å¯åŠ¨ç›‘æ§
func (w *DepositWatcher) Start(ctx context.Context) {
	log.Println("å¯åŠ¨å……å€¼ç›‘æ§å™¨...")

	ticker := time.NewTicker(w.pollInterval)
	defer ticker.Stop()

	for {
		select {
		case <-ctx.Done():
			log.Println("åœæ­¢å……å€¼ç›‘æ§å™¨")
			return
		case <-ticker.C:
			w.checkNewBlocks()
			w.updateConfirmations()
		}
	}
}

// checkNewBlocks æ£€æŸ¥æ–°åŒºå—
func (w *DepositWatcher) checkNewBlocks() {
	bestHash, err := w.client.GetBestBlockHash()
	if err != nil {
		log.Printf("è·å–æœ€æ–°åŒºå—å¤±è´¥: %v", err)
		return
	}

	if bestHash.String() == w.lastProcessedHash {
		return // æ²¡æœ‰æ–°åŒºå—
	}

	// æ£€æµ‹ Reorg
	if w.lastProcessedHash != "" {
		if err := w.detectReorg(bestHash); err != nil {
			log.Printf("Reorg æ£€æµ‹å¤±è´¥: %v", err)
		}
	}

	w.processBlock(bestHash)
	w.lastProcessedHash = bestHash.String()
}

// detectReorg æ£€æµ‹åŒºå—é‡ç»„
func (w *DepositWatcher) detectReorg(newBest *chainhash.Hash) error {
	block, err := w.client.GetBlockVerbose(newBest)
	if err != nil {
		return err
	}

	// ç®€å•æ£€æµ‹ï¼šå¦‚æœæœ€æ–°åŒºå—çš„çˆ¶å“ˆå¸Œä¸æ˜¯æˆ‘ä»¬è®°å½•çš„æœ€åå¤„ç†çš„å“ˆå¸Œ
	// ä¸”é«˜åº¦ç›¸åŒæˆ–æ›´ä½ï¼Œå¯èƒ½å‘ç”Ÿäº† Reorg
	if block.PreviousHash != w.lastProcessedHash {
		log.Printf("âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„ Reorgï¼Œæ–°åŒºå—çˆ¶å“ˆå¸Œ: %s", block.PreviousHash)
		w.handleReorg(block.Height)
	}

	return nil
}

// handleReorg å¤„ç†åŒºå—é‡ç»„
func (w *DepositWatcher) handleReorg(reorgHeight int64) {
	w.mu.Lock()
	defer w.mu.Unlock()

	for txid, deposit := range w.deposits {
		if deposit.BlockHeight >= reorgHeight && deposit.Status != StatusCredited {
			log.Printf("ğŸ”„ Reorg: å›æ»šäº¤æ˜“ %s (é«˜åº¦ %d)", txid, deposit.BlockHeight)
			deposit.Status = StatusOrphaned
			deposit.UpdatedAt = time.Now()
		}
	}
}

// processBlock å¤„ç†åŒºå—ä¸­çš„äº¤æ˜“
func (w *DepositWatcher) processBlock(blockHash *chainhash.Hash) {
	block, err := w.client.GetBlockVerbose(blockHash)
	if err != nil {
		log.Printf("è·å–åŒºå—å¤±è´¥: %v", err)
		return
	}

	log.Printf("å¤„ç†åŒºå— %d (%s), äº¤æ˜“æ•°: %d",
		block.Height, blockHash.String()[:16], len(block.Tx))

	for _, txid := range block.Tx {
		w.checkTransaction(txid, block.Hash, block.Height)
	}
}

// checkTransaction æ£€æŸ¥äº¤æ˜“æ˜¯å¦æ¶‰åŠç›‘æ§åœ°å€
func (w *DepositWatcher) checkTransaction(txid, blockHash string, height int64) {
	// è¿™é‡Œéœ€è¦è°ƒç”¨ getrawtransaction è·å–äº¤æ˜“è¯¦æƒ…
	// æ£€æŸ¥è¾“å‡ºæ˜¯å¦å‘é€åˆ°ç›‘æ§åœ°å€
	// ç®€åŒ–ç¤ºä¾‹ï¼š
	w.mu.RLock()
	_, exists := w.deposits[txid]
	w.mu.RUnlock()

	if exists {
		// æ›´æ–°ç¡®è®¤ä¿¡æ¯
		w.mu.Lock()
		w.deposits[txid].BlockHash = blockHash
		w.deposits[txid].BlockHeight = height
		w.deposits[txid].Confirmations = 1
		w.deposits[txid].UpdatedAt = time.Now()
		w.mu.Unlock()
	}
}

// updateConfirmations æ›´æ–°ç¡®è®¤æ•°
func (w *DepositWatcher) updateConfirmations() {
	currentHeight, err := w.client.GetBlockCount()
	if err != nil {
		return
	}

	w.mu.Lock()
	defer w.mu.Unlock()

	for txid, deposit := range w.deposits {
		if deposit.Status == StatusOrphaned || deposit.Status == StatusCredited {
			continue
		}

		if deposit.BlockHeight > 0 {
			confs := currentHeight - deposit.BlockHeight + 1
			deposit.Confirmations = confs

			if confs >= w.confirmThreshold && deposit.Status == StatusPending {
				deposit.Status = StatusConfirmed
				log.Printf("âœ… äº¤æ˜“ç¡®è®¤: %s (ç¡®è®¤æ•°: %d)", txid, confs)
				// è§¦å‘ä¸šåŠ¡é€»è¾‘
				w.onDepositConfirmed(deposit)
			}
		}
	}
}

// onDepositConfirmed å……å€¼ç¡®è®¤å›è°ƒ
func (w *DepositWatcher) onDepositConfirmed(deposit *Deposit) {
	log.Printf("ğŸ’° å……å€¼åˆ°è´¦: åœ°å€=%s, é‡‘é¢=%d sats, TxID=%s",
		deposit.Address, deposit.Amount, deposit.TxID)
	// è¿™é‡Œè°ƒç”¨ä¸šåŠ¡å±‚å¤„ç†å……å€¼
}

// RecordDeposit è®°å½•æ–°å……å€¼ï¼ˆ0-confï¼‰
func (w *DepositWatcher) RecordDeposit(txid, address string, amount int64) {
	w.mu.Lock()
	defer w.mu.Unlock()

	if _, exists := w.deposits[txid]; exists {
		return // å·²å­˜åœ¨
	}

	deposit := &Deposit{
		TxID:          txid,
		Address:       address,
		Amount:        amount,
		Status:        StatusPending,
		Confirmations: 0,
		CreatedAt:     time.Now(),
		UpdatedAt:     time.Now(),
	}

	w.deposits[txid] = deposit
	log.Printf("ğŸ“¥ æ£€æµ‹åˆ°æ–°å……å€¼: %s â†’ %s, %d sats", txid[:16], address, amount)
}

// GetDeposits è·å–æ‰€æœ‰å……å€¼è®°å½•
func (w *DepositWatcher) GetDeposits() []*Deposit {
	w.mu.RLock()
	defer w.mu.RUnlock()

	deposits := make([]*Deposit, 0, len(w.deposits))
	for _, d := range w.deposits {
		deposits = append(deposits, d)
	}
	return deposits
}

func main() {
	fmt.Println("=== Deposit Watcher Demo ===")
	fmt.Println("è¿™æ˜¯ä¸€ä¸ªå……å€¼ç›‘æ§å™¨çš„æ¡†æ¶ç¤ºä¾‹")
	fmt.Println("å®é™…ä½¿ç”¨æ—¶éœ€è¦è¿æ¥åˆ° Bitcoin èŠ‚ç‚¹")

	// ç¤ºä¾‹ï¼šåˆ›å»ºç›‘æ§å™¨
	// client, _ := rpcclient.New(...)
	// watcher := NewDepositWatcher(client, 6)
	// watcher.AddWatchAddress("bc1q...")
	// watcher.Start(context.Background())
}
```

---

### ä½œä¸š 4: å¹‚ç­‰å……å€¼å¤„ç†

åˆ›å»º `idempotent_deposit.go`:

```go
package main

import (
	"context"
	"database/sql"
	"errors"
	"fmt"
	"log"
	"time"
)

// å¹‚ç­‰æ€§å……å€¼å¤„ç†å™¨
// ç¡®ä¿åŒä¸€ç¬”å……å€¼ä¸ä¼šè¢«é‡å¤å¤„ç†

// DepositRecord æ•°æ®åº“è®°å½•
type DepositRecord struct {
	ID            int64
	TxID          string
	Vout          int
	Address       string
	Amount        int64
	BlockHash     string
	BlockHeight   int64
	Confirmations int64
	Status        string
	ProcessedAt   sql.NullTime
	CreatedAt     time.Time
	UpdatedAt     time.Time
}

// DepositProcessor å¹‚ç­‰å……å€¼å¤„ç†å™¨
type DepositProcessor struct {
	db               *sql.DB
	confirmThreshold int64
}

// ProcessDeposit å¹‚ç­‰å¤„ç†å……å€¼
func (p *DepositProcessor) ProcessDeposit(ctx context.Context, txid string, vout int, address string, amount int64) error {
	// 1. å°è¯•æ’å…¥è®°å½•ï¼ˆåˆ©ç”¨å”¯ä¸€ç´¢å¼•ä¿è¯å¹‚ç­‰ï¼‰
	_, err := p.db.ExecContext(ctx, `
		INSERT INTO deposits (txid, vout, address, amount, status, created_at, updated_at)
		VALUES (?, ?, ?, ?, 'pending', NOW(), NOW())
		ON DUPLICATE KEY UPDATE updated_at = NOW()
	`, txid, vout, address, amount)

	if err != nil {
		return fmt.Errorf("è®°å½•å……å€¼å¤±è´¥: %w", err)
	}

	log.Printf("å……å€¼è®°å½•å·²åˆ›å»º/æ›´æ–°: %s:%d", txid, vout)
	return nil
}

// UpdateConfirmation æ›´æ–°ç¡®è®¤çŠ¶æ€
func (p *DepositProcessor) UpdateConfirmation(ctx context.Context, txid string, blockHash string, blockHeight, confirmations int64) error {
	result, err := p.db.ExecContext(ctx, `
		UPDATE deposits
		SET block_hash = ?, block_height = ?, confirmations = ?,
		    status = CASE 
		        WHEN ? >= ? AND status = 'pending' THEN 'confirmed'
		        ELSE status
		    END,
		    updated_at = NOW()
		WHERE txid = ? AND status NOT IN ('credited', 'orphaned')
	`, blockHash, blockHeight, confirmations, confirmations, p.confirmThreshold, txid)

	if err != nil {
		return err
	}

	affected, _ := result.RowsAffected()
	if affected > 0 {
		log.Printf("æ›´æ–°ç¡®è®¤æ•°: %s, confs=%d", txid, confirmations)
	}

	return nil
}

// CreditDeposit æ‰§è¡Œå…¥è´¦ï¼ˆå¹‚ç­‰ï¼‰
func (p *DepositProcessor) CreditDeposit(ctx context.Context, txid string) error {
	tx, err := p.db.BeginTx(ctx, nil)
	if err != nil {
		return err
	}
	defer tx.Rollback()

	// 1. è·å–å¹¶é”å®šè®°å½•
	var record DepositRecord
	err = tx.QueryRowContext(ctx, `
		SELECT id, txid, address, amount, status 
		FROM deposits 
		WHERE txid = ? 
		FOR UPDATE
	`, txid).Scan(&record.ID, &record.TxID, &record.Address, &record.Amount, &record.Status)

	if err != nil {
		return fmt.Errorf("æŸ¥è¯¢å……å€¼è®°å½•å¤±è´¥: %w", err)
	}

	// 2. å¹‚ç­‰æ£€æŸ¥ï¼šå·²å¤„ç†åˆ™è·³è¿‡
	if record.Status == "credited" {
		log.Printf("å……å€¼å·²å¤„ç†ï¼Œè·³è¿‡: %s", txid)
		return nil
	}

	if record.Status != "confirmed" {
		return errors.New("å……å€¼æœªç¡®è®¤ï¼Œæ— æ³•å…¥è´¦")
	}

	// 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚å¢åŠ ç”¨æˆ·ä½™é¢ï¼‰
	// è¿™é‡Œåº”è¯¥è°ƒç”¨ä¸šåŠ¡å±‚
	log.Printf("æ‰§è¡Œå…¥è´¦: åœ°å€=%s, é‡‘é¢=%d sats", record.Address, record.Amount)

	// 4. æ›´æ–°çŠ¶æ€
	_, err = tx.ExecContext(ctx, `
		UPDATE deposits 
		SET status = 'credited', processed_at = NOW(), updated_at = NOW()
		WHERE id = ?
	`, record.ID)

	if err != nil {
		return err
	}

	return tx.Commit()
}

// HandleReorg å¤„ç† Reorg
func (p *DepositProcessor) HandleReorg(ctx context.Context, reorgHeight int64) error {
	result, err := p.db.ExecContext(ctx, `
		UPDATE deposits
		SET status = 'orphaned', updated_at = NOW()
		WHERE block_height >= ? AND status NOT IN ('credited')
	`, reorgHeight)

	if err != nil {
		return err
	}

	affected, _ := result.RowsAffected()
	log.Printf("Reorg å¤„ç†: æ ‡è®° %d æ¡è®°å½•ä¸º orphaned", affected)

	return nil
}

func main() {
	fmt.Println("=== å¹‚ç­‰å……å€¼å¤„ç†ç¤ºä¾‹ ===")

	// SQL Schema
	schema := `
CREATE TABLE deposits (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    txid VARCHAR(64) NOT NULL,
    vout INT NOT NULL DEFAULT 0,
    address VARCHAR(100) NOT NULL,
    amount BIGINT NOT NULL,
    block_hash VARCHAR(64),
    block_height BIGINT,
    confirmations INT DEFAULT 0,
    status ENUM('pending', 'confirmed', 'credited', 'orphaned') DEFAULT 'pending',
    processed_at DATETIME,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    UNIQUE KEY uk_txid_vout (txid, vout),
    INDEX idx_status (status),
    INDEX idx_address (address),
    INDEX idx_block_height (block_height)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
`
	fmt.Println("æ•°æ®åº“ Schema:")
	fmt.Println(schema)

	fmt.Println("\nå…³é”®è®¾è®¡ç‚¹:")
	fmt.Println("1. txid + vout å”¯ä¸€ç´¢å¼•ä¿è¯å¹‚ç­‰")
	fmt.Println("2. status çŠ¶æ€æœºæ§åˆ¶æµç¨‹")
	fmt.Println("3. FOR UPDATE è¡Œé”é˜²æ­¢å¹¶å‘")
	fmt.Println("4. block_height ç”¨äº Reorg å›æ»š")
}
```

---

### ä½œä¸š 5: ZMQ ç›‘å¬å™¨

åˆ›å»º `zmq_listener.go`:

```go
package main

import (
	"encoding/hex"
	"fmt"
	"log"
	"os"
	"os/signal"
	"syscall"

	"github.com/btcsuite/btcd/wire"
)

// ZMQListener ZMQ ç›‘å¬å™¨æ¥å£
type ZMQListener struct {
	hashBlockEndpoint string
	hashTxEndpoint    string
	rawBlockEndpoint  string
	rawTxEndpoint     string
}

// NewZMQListener åˆ›å»º ZMQ ç›‘å¬å™¨
func NewZMQListener() *ZMQListener {
	return &ZMQListener{
		hashBlockEndpoint: "tcp://127.0.0.1:28332",
		hashTxEndpoint:    "tcp://127.0.0.1:28332",
		rawBlockEndpoint:  "tcp://127.0.0.1:28333",
		rawTxEndpoint:     "tcp://127.0.0.1:28333",
	}
}

// æ³¨æ„ï¼šå®é™…ä½¿ç”¨éœ€è¦å®‰è£… ZMQ åº“
// go get github.com/pebbe/zmq4
//
// ä»¥ä¸‹æ˜¯ä¼ªä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºå¤„ç†é€»è¾‘

func (z *ZMQListener) StartHashBlockListener() {
	log.Printf("å¯åŠ¨ HashBlock ç›‘å¬: %s", z.hashBlockEndpoint)

	// subscriber, _ := zmq4.NewSocket(zmq4.SUB)
	// subscriber.Connect(z.hashBlockEndpoint)
	// subscriber.SetSubscribe("hashblock")
	//
	// for {
	//     msg, _ := subscriber.RecvMessageBytes(0)
	//     topic := string(msg[0])
	//     blockHash := hex.EncodeToString(msg[1])
	//     log.Printf("æ–°åŒºå—: %s", blockHash)
	// }
}

func (z *ZMQListener) StartRawTxListener() {
	log.Printf("å¯åŠ¨ RawTx ç›‘å¬: %s", z.rawTxEndpoint)

	// subscriber, _ := zmq4.NewSocket(zmq4.SUB)
	// subscriber.Connect(z.rawTxEndpoint)
	// subscriber.SetSubscribe("rawtx")
	//
	// for {
	//     msg, _ := subscriber.RecvMessageBytes(0)
	//     rawTx := msg[1]
	//     tx := wire.NewMsgTx(wire.TxVersion)
	//     tx.Deserialize(bytes.NewReader(rawTx))
	//     z.processTx(tx)
	// }
}

func (z *ZMQListener) processTx(tx *wire.MsgTx) {
	txid := tx.TxHash().String()
	log.Printf("æ”¶åˆ°äº¤æ˜“: %s", txid)

	for i, out := range tx.TxOut {
		log.Printf("  è¾“å‡º %d: %d sats", i, out.Value)
		// è§£æè„šæœ¬ï¼Œæ£€æŸ¥æ˜¯å¦å‘é€åˆ°ç›‘æ§åœ°å€
	}
}

func main() {
	fmt.Println("=== ZMQ ç›‘å¬å™¨ç¤ºä¾‹ ===")
	fmt.Println()
	fmt.Println("Bitcoin Core é…ç½® (bitcoin.conf):")
	fmt.Println("```")
	fmt.Println("zmqpubhashtx=tcp://127.0.0.1:28332")
	fmt.Println("zmqpubhashblock=tcp://127.0.0.1:28332")
	fmt.Println("zmqpubrawtx=tcp://127.0.0.1:28333")
	fmt.Println("zmqpubrawblock=tcp://127.0.0.1:28333")
	fmt.Println("```")
	fmt.Println()

	fmt.Println("ZMQ Topic è¯´æ˜:")
	fmt.Println("â€¢ hashblock - æ–°åŒºå—å“ˆå¸Œ (32 bytes)")
	fmt.Println("â€¢ hashtx    - æ–°äº¤æ˜“å“ˆå¸Œ (32 bytes)")
	fmt.Println("â€¢ rawblock  - å®Œæ•´åŒºå—æ•°æ®")
	fmt.Println("â€¢ rawtx     - å®Œæ•´äº¤æ˜“æ•°æ®")
	fmt.Println()

	fmt.Println("å®‰è£… ZMQ Go åº“:")
	fmt.Println("  go get github.com/pebbe/zmq4")
	fmt.Println()
	fmt.Println("æ³¨æ„: éœ€è¦å…ˆå®‰è£…ç³»ç»Ÿ ZMQ åº“:")
	fmt.Println("  macOS: brew install zeromq")
	fmt.Println("  Ubuntu: apt install libzmq3-dev")

	// ç­‰å¾…ä¸­æ–­ä¿¡å·
	sigChan := make(chan os.Signal, 1)
	signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
	<-sigChan
}
```

---

## ğŸ“ å¤ä¹ è¦ç‚¹

### å…³é”®æ¦‚å¿µæ£€æŸ¥æ¸…å•

- [ ] Bitcoin Core RPC å’Œ btcd çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] SPV å®¢æˆ·ç«¯å¦‚ä½•éªŒè¯äº¤æ˜“ï¼ŸMerkle Proof çš„ä½œç”¨ï¼Ÿ
- [ ] ä»€ä¹ˆæ˜¯ RBFï¼Ÿå®ƒå¯¹ 0-conf äº¤æ˜“æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ
- [ ] RPC è½®è¯¢å’Œ ZMQ è®¢é˜…å„æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ
- [ ] ä»€ä¹ˆæ˜¯ Reorgï¼Ÿå¦‚ä½•åœ¨ç³»ç»Ÿä¸­å¤„ç†ï¼Ÿ
- [ ] å¦‚ä½•ä¿è¯å……å€¼å¤„ç†çš„å¹‚ç­‰æ€§ï¼Ÿ

### å¸¸è§é”™è¯¯ä¸é™·é˜±

> [!CAUTION]
> **æ³¨æ„äº‹é¡¹**
> 
> 1. **0-conf é£é™©**ï¼šæœªç¡®è®¤äº¤æ˜“å¯èƒ½è¢«åŒèŠ±æˆ– RBF æ›¿æ¢
> 2. **Reorg å¤„ç†**ï¼šå¿…é¡»ç›‘æ§åŒºå—é“¾é‡ç»„ï¼ŒåŠæ—¶å›æ»š
> 3. **å¹‚ç­‰æ€§**ï¼šåŒä¸€ç¬”äº¤æ˜“å¯èƒ½è¢«å¤šæ¬¡å¤„ç†ï¼Œå¿…é¡»é˜²æ­¢é‡å¤å…¥è´¦
> 4. **èŠ‚ç‚¹åŒæ­¥**ï¼šç¡®ä¿èŠ‚ç‚¹å®Œå…¨åŒæ­¥åå†å¯åŠ¨æœåŠ¡

### è¿›é˜¶æ€è€ƒ

1. **å¦‚ä½•ä¼˜åŒ–å¤§è§„æ¨¡åœ°å€ç›‘æ§ï¼Ÿ**
   - ä½¿ç”¨ Electrum Server æˆ–è‡ªå»ºç´¢å¼•
   - æŒ‰åœ°å€å‰ç¼€åˆ†ç‰‡

2. **å¦‚ä½•å¤„ç†æ‰‹ç»­è´¹ä¸è¶³çš„äº¤æ˜“ï¼Ÿ**
   - ç›‘æ§ Mempool çŠ¶æ€
   - å®ç° CPFP (Child Pays For Parent)

3. **å¦‚ä½•è®¾è®¡é«˜å¯ç”¨çš„ Watcher æœåŠ¡ï¼Ÿ**
   - å¤šèŠ‚ç‚¹å†—ä½™
   - æ–­ç‚¹ç»­ä¼ 
   - å¥åº·æ£€æŸ¥

---

## ğŸ”— å»¶ä¼¸é˜…è¯»

- [Bitcoin Core RPC æ–‡æ¡£](https://developer.bitcoin.org/reference/rpc/)
- [btcd JSON-RPC API](https://github.com/btcsuite/btcd/blob/master/docs/json_rpc_api.md)
- [BIP-37: Bloom Filtering](https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki)
- [BIP-157/158: Compact Block Filters](https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki)
- [Bitcoin ZMQ æ–‡æ¡£](https://github.com/bitcoin/bitcoin/blob/master/doc/zmq.md)

---

**Day 6 å®Œæˆï¼** ğŸ‰

æ˜å¤©æˆ‘ä»¬å°†è¿›è¡Œ **Week 1 å¤ä¹ ä¸ Mini Project**ï¼Œæ„å»ºå®Œæ•´çš„ Bitcoin æ”¶æ¬¾ç›‘å¬æœåŠ¡ã€‚
